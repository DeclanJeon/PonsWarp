name: Security Scan

on:
  push:
    branches: [ develop, master ]
  pull_request:
    branches: [ develop, master ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì‹¤í–‰
    - cron: '0 0 * * *'

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        scan-type: [dependencies, code, secrets]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '8'
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
          
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    # ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
    - name: Run npm audit
      if: matrix.scan-type == 'dependencies'
      run: |
        echo "ðŸ” Running npm audit for dependency vulnerabilities..."
        pnpm audit --audit-level moderate
        
    - name: Run Snyk to check for vulnerabilities
      if: matrix.scan-type == 'dependencies'
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    # ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
    - name: Run CodeQL Analysis
      if: matrix.scan-type == 'code'
      uses: github/codeql-action/analyze@v2
      with:
        languages: javascript
        
    - name: Run semgrep security scan
      if: matrix.scan-type == 'code'
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/typescript
        
    # ì‹œí¬ë¦¿ ìŠ¤ìº”
    - name: Run TruffleHog OSS
      if: matrix.scan-type == 'secrets'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        
    - name: Run gitleaks
      if: matrix.scan-type == 'secrets'
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # ê²°ê³¼ ë³´ê³ 
    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results-${{ matrix.scan-type }}
        path: |
          security-reports/
          *.sarif
        retention-days: 30
        
    - name: Comment PR with security results
      if: github.event_name == 'pull_request' && matrix.scan-type == 'dependencies'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = './security-reports/dependency-report.json';
          
          if (fs.existsSync(path)) {
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const vulnerabilities = report.vulnerabilities || [];
            
            if (vulnerabilities.length > 0) {
              const comment = `## ðŸ”’ Security Scan Results
              
              Found **${vulnerabilities.length}** security vulnerabilities:
              
              ${vulnerabilities.map(v => 
                `- **${v.severity}**: ${v.package}@${v.version} - ${v.title}`
              ).join('\n')}
              
              Please review and fix these vulnerabilities before merging.
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          }

  # ë³´ì•ˆ ì •ì±… ê²€ì‚¬
  security-policy:
    name: Security Policy Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for security-related changes
      run: |
        echo "ðŸ” Checking for security-related changes..."
        
        # ë³´ì•ˆ ê´€ë ¨ íŒŒì¼ ë³€ê²½ í™•ì¸
        SECURITY_FILES=(
          ".github/workflows/security-scan.yml"
          "package.json"
          "pnpm-lock.yaml"
          "tsconfig.json"
          "vite.config.ts"
        )
        
        CHANGED_SECURITY_FILES=false
        
        for file in "${SECURITY_FILES[@]}"; do
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "$file"; then
            echo "âš ï¸ Security-related file changed: $file"
            CHANGED_SECURITY_FILES=true
          fi
        done
        
        if [ "$CHANGED_SECURITY_FILES" = true ]; then
          echo "::warning::Security-related files were modified. Please review carefully."
          echo "security_review_required=true" >> $GITHUB_ENV
        fi
        
    - name: Request security review
      if: env.security_review_required == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ”’ Security Review Required
            
            This PR modifies security-related files. Please ensure:
            
            - [ ] Dependencies are properly vetted
            - [ ] No sensitive information is exposed
            - [ ] Security configurations are correct
            - [ ] Build configurations are secure
            
            A security team member should review these changes.`
          })
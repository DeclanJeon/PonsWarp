name: Code Quality & Performance

on:
  push:
    branches: [ develop, master ]
  pull_request:
    branches: [ develop, master ]

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '8'
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
          
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    # íƒ€ì… ê²€ì‚¬
    - name: TypeScript type check
      run: |
        echo "ğŸ” Running TypeScript type check..."
        pnpm type-check
        
    # ë¦°íŠ¸ ê²€ì‚¬
    - name: ESLint check
      run: |
        echo "ğŸ” Running ESLint..."
        pnpm lint
        
    # ì½”ë“œ í¬ë§· ê²€ì‚¬
    - name: Prettier check
      run: |
        echo "ğŸ” Running Prettier check..."
        npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,md}"
        
    # ì½”ë“œ ë³µì¡ë„ ë¶„ì„
    - name: Code complexity analysis
      run: |
        echo "ğŸ” Analyzing code complexity..."
        npx plato -r -d complexity-report -t "PonsWarp Complexity" src/
        
    # ë²ˆë“¤ í¬ê¸° ë¶„ì„
    - name: Bundle size analysis
      run: |
        echo "ğŸ” Analyzing bundle size..."
        pnpm build
        npx bundlesize
        
    # ì„±ëŠ¥ ë¶„ì„
    - name: Performance analysis
      run: |
        echo "ğŸ” Running performance analysis..."
        npx lighthouse --chrome-flags="--headless" --output=json --output-path=./lighthouse-report.json http://localhost:4173 &
        
        # ë¹Œë“œëœ ì•± ì„œë²„ ì‹œì‘
        npx serve -s dist -l 4173 &
        SERVE_PID=$!
        
        # Lighthouse ì‹¤í–‰ì„ ìœ„í•œ ëŒ€ê¸°
        sleep 30
        
        # ì„œë²„ ì¢…ë£Œ
        kill $SERVE_PID
        
    # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
    - name: Test coverage
      run: |
        echo "ğŸ” Running test coverage..."
        pnpm test:coverage
        
    # ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±
    - name: Generate quality report
      run: |
        echo "ğŸ“Š Generating quality report..."
        
        # ë³´ê³ ì„œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p quality-report
        
        # ìš”ì•½ ì •ë³´ ìƒì„±
        cat > quality-report/summary.md << EOF
        # Code Quality Report
        
        ## ğŸ“Š Metrics
        
        - **TypeScript**: âœ… No type errors
        - **ESLint**: âœ… No linting errors
        - **Prettier**: âœ… Code formatted correctly
        - **Test Coverage**: $(npx nyc report --reporter=text-summary | grep "Lines" | awk '{print $2}')
        - **Bundle Size**: $(du -h dist/ | cut -f1)
        
        ## ğŸ” Details
        
        ### Complexity Analysis
        ![Complexity Report](complexity-report/overview.html)
        
        ### Performance Metrics
        - Performance Score: $(cat lighthouse-report.json | jq '.categories.performance.score * 100')
        - Accessibility Score: $(cat lighthouse-report.json | jq '.categories.accessibility.score * 100')
        - Best Practices Score: $(cat lighthouse-report.json | jq '.categories["best-practices"].score * 100')
        - SEO Score: $(cat lighthouse-report.json | jq '.categories.seo.score * 100')
        
        ### Test Coverage
        ![Coverage Report](coverage/lcov-report/index.html)
        
        ---
        
        ğŸ“… Generated on: $(date)
        ğŸ”„ Commit: ${{ github.sha }}
        EOF
        
    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports
        path: |
          quality-report/
          complexity-report/
          coverage/
          lighthouse-report.json
        retention-days: 30
        
    - name: Comment PR with quality metrics
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì½ê¸°
          let coverageInfo = "N/A";
          if (fs.existsSync('coverage/coverage-summary.json')) {
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            coverageInfo = `${coverage.total.lines.pct}%`;
          }
          
          // ë²ˆë“¤ í¬ê¸° ì½ê¸°
          let bundleSize = "N/A";
          if (fs.existsSync('dist')) {
            const { execSync } = require('child_process');
            bundleSize = execSync('du -h dist/ | cut -f1').toString().trim();
          }
          
          // Lighthouse ì ìˆ˜ ì½ê¸°
          let perfScore = "N/A";
          if (fs.existsSync('lighthouse-report.json')) {
            const lighthouse = JSON.parse(fs.readFileSync('lighthouse-report.json', 'utf8'));
            perfScore = Math.round(lighthouse.categories.performance.score * 100);
          }
          
          const comment = `## ğŸ“Š Code Quality Metrics
          
          | Metric | Value | Status |
          |--------|--------|--------|
          | ğŸ§ª Test Coverage | ${coverageInfo} | ${coverageInfo !== "N/A" && parseFloat(coverageInfo) >= 80 ? "âœ…" : "âš ï¸"} |
          | ğŸ“¦ Bundle Size | ${bundleSize} | ${bundleSize !== "N/A" ? "âœ…" : "âš ï¸"} |
          | âš¡ Performance Score | ${perfScore} | ${perfScore !== "N/A" && perfScore >= 90 ? "âœ…" : "âš ï¸"} |
          | ğŸ” Type Check | âœ… | âœ… |
          | ğŸ“ Lint Check | âœ… | âœ… |
          | ğŸ¨ Format Check | âœ… | âœ… |
          
          ### ğŸ“ˆ Recommendations
          
          ${coverageInfo !== "N/A" && parseFloat(coverageInfo) < 80 ? "- ğŸ§ª Consider adding more tests to improve coverage\n" : ""}
          ${perfScore !== "N/A" && perfScore < 90 ? "- âš¡ Optimize performance for better user experience\n" : ""}
          
          ---
          
          ğŸ“Š [Detailed Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ì„±ëŠ¥ íšŒê·€ í…ŒìŠ¤íŠ¸
  performance-regression:
    name: Performance Regression Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: '8'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build current branch
      run: pnpm build
      
    - name: Analyze current bundle
      run: |
        npx webpack-bundle-analyzer dist/static/js/*.js -m json -r bundle-current.json
        
    - name: Checkout base branch
      run: |
        git checkout origin/${{ github.base_ref }}
        pnpm install --frozen-lockfile
        pnpm build
        
    - name: Analyze base bundle
      run: |
        npx webpack-bundle-analyzer dist/static/js/*.js -m json -r bundle-base.json
        
    - name: Compare bundle sizes
      run: |
        node -e "
        const current = require('./bundle-current.json');
        const base = require('./bundle-base.json');
        
        const currentSize = current.reduce((sum, chunk) => sum + chunk.parsedSize, 0);
        const baseSize = base.reduce((sum, chunk) => sum + chunk.parsedSize, 0);
        
        const change = ((currentSize - baseSize) / baseSize * 100).toFixed(2);
        
        console.log('Current bundle size:', currentSize, 'bytes');
        console.log('Base bundle size:', baseSize, 'bytes');
        console.log('Size change:', change + '%');
        
        if (Math.abs(parseFloat(change)) > 10) {
          console.log('âš ï¸ Significant bundle size change detected!');
          process.exit(1);
        }
        "